# Flatpak-only test: build-android-linux + build-flatpak. No Windows, macOS, or release.
# Trigger via: Actions → "Flatpak test" → Run workflow,
# or push tag v0.3.0-flatpak-test.1 (or any v*-flatpak-test*).
name: Flatpak test

on:
  workflow_dispatch:
  push:
    tags:
      - 'v*-flatpak-test*'

permissions:
  contents: read

jobs:
  build-android-linux:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Get version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF_NAME#v}" >> $GITHUB_OUTPUT

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.41.1'
          channel: 'stable'
          cache: true

      - name: Cache Gradle
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
            android/.gradle
          key: gradle-${{ runner.os }}-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: gradle-${{ runner.os }}-

      - name: Install dependencies
        run: flutter pub get

      - name: Build APK
        run: flutter build apk --release --target-platform android-arm64

      - name: Install Linux build dependencies
        run: |
          sudo apt-get update -y
          sudo apt-get install -y \
            clang \
            cmake \
            ninja-build \
            pkg-config \
            libgtk-3-dev \
            libstdc++-12-dev \
            liblzma-dev \
            libsecret-1-dev

      - name: Build Linux
        run: flutter build linux --release

      - name: Prepare release artifacts
        run: |
          mkdir -p build/release
          cd build/linux/x64/release/bundle
          zip -r ../../../../release/GitSyncMarks-Mobile-${{ steps.version.outputs.VERSION }}-linux-x64.zip .
          tar -czf ../../../../release/GitSyncMarks-Mobile-Linux-Portable.tar.gz . --owner=root --group=root
          cd -

      - name: Upload Linux bundle for Flatpak
        uses: actions/upload-artifact@v4
        with:
          name: linux-bundle
          path: build/release/GitSyncMarks-Mobile-Linux-Portable.tar.gz

  build-flatpak:
    runs-on: ubuntu-latest
    needs: build-android-linux
    container:
      image: ghcr.io/flathub-infra/flatpak-github-actions:gnome-47
      options: --privileged
    steps:
      - uses: actions/checkout@v4

      - name: Download Linux bundle
        uses: actions/download-artifact@v4
        with:
          name: linux-bundle

      - name: Prepare Flatpak build
        run: |
          TAR="$(find . -maxdepth 2 -name 'GitSyncMarks-Mobile-Linux-Portable.tar.gz' | head -1)"
          if [ -z "$TAR" ]; then
            TAR="$(find . -maxdepth 3 -name '*.tar.gz' | head -1)"
          fi
          if [ -z "$TAR" ]; then
            echo "::error::Linux bundle tar.gz not found after download"
            exit 1
          fi
          cp "$TAR" flatpak/GitSyncMarks-Mobile-Linux-Portable.tar.gz
          chmod +x flatpak/build-flatpak.sh

      - name: Build Flatpak
        uses: flatpak/flatpak-github-actions/flatpak-builder@v6
        with:
          bundle: GitSyncMarks-Mobile-${{ github.ref_name }}.flatpak
          manifest-path: flatpak/io.github.d0dg3r.GitSyncMarksMobile.yml
          cache-key: flatpak-${{ github.sha }}
          upload-artifact: false

      - name: Upload Flatpak
        uses: actions/upload-artifact@v4
        with:
          name: release-flatpak
          path: "**/GitSyncMarks-Mobile-*.flatpak"
