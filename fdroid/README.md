# F-Droid Submission

This folder contains metadata for submitting GitSyncMarks-App to [F-Droid](https://f-droid.org/).

## Release workflow (correct order)

1. **Release as usual:** Version bump in `pubspec.yaml`, update `CHANGELOG.md`, commit and push.
2. **Tag:** `git tag vX.Y.Z && git push origin vX.Y.Z`
3. **Update F-Droid metadata** (in a separate commit, before or after the tag):
   - In [com.d0dg3r.gitsyncmarks-fdroid-submit.yml](metadata/com.d0dg3r.gitsyncmarks-fdroid-submit.yml): keep only the current stable build block (`versionName`, `versionCode`, `commit`)
   - For cross-channel updates, keep `AllowedAPKSigningKeys` at top-level and `binary:` in the current build block.
   - No comments in YAML (rewritemeta fails).
   - Create [metadata/com.d0dg3r.gitsyncmarks/en-US/changelogs/{versionCode}.txt](metadata/com.d0dg3r.gitsyncmarks/en-US/changelogs/)
   - Update `CurrentVersion` and `CurrentVersionCode`
4. **Verify:** `git rev-parse vX.Y.Z` must match `commit:` in the YAML (or use tag name directly).
5. **Submit:** `./fdroid/submit-to-gitlab.sh` from project root.

The tag must exist before submitting. Use the **full commit hash** in `commit:` (not the tag name) â€“ F-Droid's shallow clone may not fetch tags. Get it with `git rev-parse vX.Y.Z`.

## Do this, then this (copy/paste)

### Stable release

```bash
git checkout main
git pull
git tag vX.Y.Z
git push origin vX.Y.Z
./fdroid/submit-to-gitlab.sh --validate-only
./fdroid/submit-to-gitlab.sh YOUR_GITLAB_USER
```

### Recovery if tag was wrong

```bash
git checkout main
git pull
git tag -d vX.Y.Z
git push origin :refs/tags/vX.Y.Z
git tag vX.Y.Z
git push origin vX.Y.Z
```

After retagging, update `commit:` in submit metadata to `git rev-parse vX.Y.Z`, then run:

```bash
./fdroid/submit-to-gitlab.sh --validate-only
./fdroid/submit-to-gitlab.sh YOUR_GITLAB_USER
```

## One-command submission (GitLab + SSH)

1. Fork [fdroiddata](https://gitlab.com/fdroid/fdroiddata) on GitLab (once)
2. Run from the project root:

   ```bash
   chmod +x fdroid/submit-to-gitlab.sh
   ./fdroid/submit-to-gitlab.sh YOUR_GITLAB_USER
   ```

   Replace `YOUR_GITLAB_USER` with your GitLab username (e.g. `d0dg3r`). Use `--force` to overwrite the remote branch (e.g. when updating and MR has no review changes to keep).

3. Open the MR link printed at the end, or go to [New Merge Request](https://gitlab.com/fdroid/fdroiddata/-/merge_requests/new) and select branch `com.d0dg3r.gitsyncmarks` from your fork.

## Manual submission

1. Fork [fdroiddata](https://gitlab.com/fdroid/fdroiddata) on GitLab
2. Clone your fork, create branch:

   ```bash
   git clone --depth=1 git@gitlab.com:YOUR_USER/fdroiddata ~/fdroiddata
   cd ~/fdroiddata
   git checkout -b com.d0dg3r.gitsyncmarks
   ```

3. Copy metadata: `cp /path/to/GitSyncMarks-App/fdroid/metadata/com.d0dg3r.gitsyncmarks-fdroid-submit.yml metadata/com.d0dg3r.gitsyncmarks.yml`
4. Commit and push: `git add metadata/com.d0dg3r.gitsyncmarks.yml && git commit -m "New App: com.d0dg3r.gitsyncmarks" && git push -u origin com.d0dg3r.gitsyncmarks`
5. Open a [Merge Request](https://gitlab.com/fdroid/fdroiddata/-/merge_requests/new)

## Upstream metadata

The app repository includes F-Droid-compatible metadata (Fastlane structure). `metadata/` at repo root mirrors `fdroid/metadata/com.d0dg3r.gitsyncmarks/` so F-Droid finds it when building:

- `metadata/en-US/short_description.txt` (Fastlane; F-Droid accepts this from app repo)
- `metadata/en-US/full_description.txt` (Fastlane; F-Droid accepts this from app repo)
- `metadata/en-US/images/icon.png` (512x512)
- `metadata/en-US/images/phoneScreenshots/1.png`, `2.png`, `3.png` (Light, Dark, Settings)
- `metadata/en-US/changelogs/{versionCode}.txt`

Screenshots are generated by `./scripts/generate-screenshots.sh` and copied to both `flatpak/screenshots/` and `fdroid/.../phoneScreenshots/`. F-Droid requires at least one screenshot for the Latest tab.

## Flutter build config (do not change)

F-Droid reviewer (linsui) requires extracting the Flutter version from the repo, not hardcoding it. Use `flutter@stable` in srclibs and prebuild steps that read from `.github/workflows/release.yml`. Do **not** replace with `flutter@3.41.1` or similar.

## Reproducible builds and signer verification

This project uses the F-Droid upstream-signed APK verification path:

- `AllowedAPKSigningKeys` pins the expected SHA256 certificate fingerprint.
- `Builds.binary` points to the upstream release APK URL.
- `UpdateCheckMode: Tags ^v[0-9.]+$` filters pre-release tags for submit metadata.

CI workflow `F-Droid Validate` performs a reproducibility preflight:

- checks stable-only submit metadata
- validates deterministic metadata settings for the current build
- downloads upstream APK and verifies signer fingerprint against `AllowedAPKSigningKeys`
- uploads verification logs as workflow artifacts

## Fixing CI: check apk (Dependency metadata)

If the F-Droid CI fails with `ERROR Found extra signing block 'Dependency metadata'`, the app's `android/app/build.gradle` must include `dependenciesInfo { includeInApk = false }` in the `android` block. This disables the AGP dependency metadata block that F-Droid's scanner rejects. A new release (commit) with this fix is required before re-submitting.

## Fixing CI: check-localized-metadata

If the F-Droid CI fails with "should use fdroid name summary.txt/description.txt", the metadata folder must not be in fdroiddata. Metadata comes from the app repo. In your fdroiddata fork, on branch `com.d0dg3r.gitsyncmarks`:

```bash
cd ~/fdroiddata  # or your fdroiddata clone
git checkout com.d0dg3r.gitsyncmarks
rm -rf metadata/com.d0dg3r.gitsyncmarks
git add metadata/
git commit -m "Remove localized metadata (use app repo)"
git push origin com.d0dg3r.gitsyncmarks
```
