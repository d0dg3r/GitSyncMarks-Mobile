---
description: Release workflow – Tag, F-Droid, GitHub Releases
alwaysApply: false
globs: pubspec.yaml, CHANGELOG.md, .github/workflows/*, fdroid/**/*
---

# Release Workflow

When preparing or executing a release:

1. **Order (mandatory):** Finalize version/changelog → Merge to `main` → Tag on final merge commit → Verify GitHub release workflow success → Verify F-Droid `commit:` hash → Submit to F-Droid

2. **Tag:** Set on exactly the final merge commit (not on an older commit)

3. **F-Droid:** `commit:` in [fdroid/metadata/com.d0dg3r.gitsyncmarks-fdroid-submit.yml](fdroid/metadata/com.d0dg3r.gitsyncmarks-fdroid-submit.yml) must match the tag commit. Verify before submit: `git rev-parse vX.Y.Z` = `commit:` in the YAML.

4. **GitHub Releases:** Only stable tags (`v*` without `-`) as "latest"; pre-releases (`-beta`, `-rc`, `-test`) visible but not latest

5. **Screenshots:** Generate locally with `./scripts/generate-screenshots.sh` before tagging (Light + Dark for README, Flatpak, F-Droid). CI screenshot disabled until fonts/CI consistency is fixed.

6. **Before F-Droid MR:** Run `./fdroid/submit-to-gitlab.sh` – validates version/tag/hash/changelog gates and copies the submit file

7. **Hard stop gates:** Do not submit if any of these fail:
   - `pubspec.yaml` version != `CurrentVersion` in submit metadata
   - missing F-Droid changelog file for `CurrentVersionCode`
   - missing tag `vX.Y.Z` for `CurrentVersion`
   - tag commit != submit metadata `commit:`

8. **Recovery for wrong tag/release:** If a release tag was set on the wrong commit, delete local+remote tag, finish merges, recreate the tag on final `main` commit, and then update submit metadata `commit:` to the new tag hash.

See also [release-checklist-hygiene.mdc](release-checklist-hygiene.mdc), [fdroid-maintenance.mdc](fdroid-maintenance.mdc), and [fdroid/README.md](fdroid/README.md).
